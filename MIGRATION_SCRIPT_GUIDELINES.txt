MIGRATION SCRIPT GUIDELINES
============================

User Preferences for Script Creation
-------------------------------------

1. SCRIPT NUMBERING
   - Use .01 increments, NOT .1 increments
   - Examples: phase2_01, phase2_02, phase2_03 (NOT phase2_1, phase2_2)
   - This keeps scripts in proper alphabetical/numerical order

2. DO NOT AUTO-APPLY PATCHES
   - Create the script and present it to the user
   - Let the USER run the script with --execute
   - Never apply patches automatically in the conversation
   - The user prefers to manually review and run each script

3. LINE ENDING ISSUES (CRITICAL)
   - Windows Git often normalizes line endings to LF (Unix style)
   - This breaks simple string matching in Python scripts
   - ALWAYS use regular expressions (re module) for pattern matching
   - Use re.MULTILINE flag and handle both \r\n and \n
   - Example:
     ```python
     import re
     pattern = re.compile(r'some_pattern', re.MULTILINE)
     new_content, count = pattern.subn(replacement, content)
     ```

4. FILE HANDLING
   - Read files with: open(filepath, 'r', encoding='utf-8')
   - Write files preserving original line endings when possible
   - For binary safety: read with 'rb', write with 'wb'

5. PATTERN MATCHING ROBUSTNESS
   - Multi-line string replacements often fail due to whitespace/line ending differences
   - Use smaller, more specific patterns when possible
   - Search for unique function signatures or variable assignments
   - If multi-line patterns fail, break into multiple single-line replacements

6. BACKUP STRATEGY
   - All scripts should create b_scriptname/ folder
   - Copy original files to backup folder before modifying
   - Also backup the migration script itself to the backup folder
   - User can restore from backup if needed

7. DEBUG OUTPUT
   - print() statements work fine in tkinter applications
   - User has been using print debugging for years successfully
   - If no output appears, the code path isn't executing (not a tkinter issue)

8. SCRIPT STRUCTURE
   - Include dry-run mode (default)
   - Require --execute flag to actually make changes
   - Show what will be changed in dry-run
   - Confirm with user before executing
   - Provide clear success/failure messages
   - List what was changed after completion

9. WHEN PATTERNS FAIL
   - Don't keep trying variations of the same approach
   - If 2-3 attempts fail, provide manual instructions instead
   - Show the user exactly what code to find and replace
   - Manual edits are often faster than debugging pattern matching

10. COMMON ISSUES ENCOUNTERED
    - Line endings (CRLF vs LF) - use regex
    - Indentation differences - capture and reuse
    - Comment variations - don't rely on comments in patterns
    - Multiple similar patterns in same file - use context to disambiguate

EXAMPLE GOOD SCRIPT STRUCTURE
------------------------------

```python
#!/usr/bin/env python3
"""
Phase X.YY Migration: Brief Description

Detailed explanation of what this script does and why.

Changes:
1. File: specific change
2. File: specific change

Usage:
    python migrate_phaseX_YY_name.py          # Dry run
    python migrate_phaseX_YY_name.py --execute  # Execute
"""

import sys
import shutil
import os
import re  # For line-ending safe pattern matching


class PhaseX_YY_Migration:
    """Brief description"""
    
    def __init__(self, execute=False):
        self.execute = execute
        self.project_dir = os.getcwd()
        
        script_name = os.path.splitext(os.path.basename(sys.argv[0]))[0]
        self.backup_folder = os.path.join(self.project_dir, f"b_{script_name}")
    
    def backup_file(self, filepath):
        """Copy file to backup folder"""
        # Implementation...
    
    def modify_file(self):
        """Modify specific file"""
        # Use regex for pattern matching
        # Handle both line endings
        # Return True/False for success
    
    def run(self):
        """Execute the migration"""
        if not self.execute:
            # Show dry-run output
            return
        
        # Confirm with user
        # Execute changes
        # Report results


def main():
    execute = "--execute" in sys.argv
    migration = PhaseX_YY_Migration(execute=execute)
    success = migration.run()
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
```

PROJECT-SPECIFIC NOTES
----------------------

This project: Air-Scenting Logger (SAR Dog Training Database)

Key files and their purposes:
- ui.py - Main UI initialization
- ui_navigation.py - Session navigation, loading, delete/undelete
- ui_form_management.py - Form operations (new, save, validate)
- ui_database.py - DatabaseOperations wrapper class
- ui_misc2.py - Dog-related operations, save_session
- ui_misc_data_ops.py - Data loading, startup sequences
- database.py - DatabaseManager class (low-level DB operations)
- sv.py - Shared variables (all StringVar/IntVar instances)
- schema.py - Database schema definitions
- setup_tab.py - Setup tab operations

Common patterns:
- DatabaseOperations(self.ui).method_name() - Wrapper calls
- db_manager.method_name() - Direct DatabaseManager calls
- sv.variable_name.get() / sv.variable_name.set() - Variable access
- from sv import sv - Import at function level to avoid circular imports

COMPLETED MIGRATION SUMMARY
---------------------------

Soft-Delete Migration (Phases 1-3):
- Added 'status' column to training_sessions table
- Implemented soft delete (mark as deleted, not remove from DB)
- Added radio button filter (Active/Deleted/Both)
- Computed session numbers based on filtered list
- Delete/Undelete buttons with proper state management
- Red/bold LabelFrame title for deleted sessions
- Consistent computed numbering throughout entire UI

Key decision: Keep session_number in database as internal ID
Display number: Computed ordinal position in filtered list

All locations now use computed numbers:
- Startup (ui_misc_data_ops.py step5)
- New button (ui_form_management.py)
- Save Session (ui_misc2.py)
- Load Session (ui_navigation.py)
- Change Dog (ui_misc2.py on_dog_changed)
- Edit/Delete Dialog (ui_navigation.py)
- Filter changes (ui_navigation.py on_status_filter_changed)

END OF GUIDELINES
